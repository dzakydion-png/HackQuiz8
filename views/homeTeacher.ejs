<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Guru - HackQuiz8</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

  <%- include('partials/_navbar') %>

  <div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="fw-bold text-dark mb-0">Dashboard Pengajar</h2>
        <p class="text-muted small">Pantau perkembangan siswa dan kelola soal.</p>
      </div>
      <a href="/teacher/<%= teacherId %>/exercise/add" class="btn btn-primary shadow-sm">
        <i class="bi bi-plus-circle me-2"></i>Tambah Soal Baru
      </a>
    </div>

   <div class="row g-4 mb-5">
      <% chartDataPerCategory.forEach((cat, idx) => { %>
        <div class="col-md-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 pt-4 pb-0">
              <h6 class="fw-bold text-uppercase text-secondary small">Statistik: <%= cat.name %></h6>
            </div>
            <div class="card-body">
              <canvas id="chart-<%= idx %>" height="200"></canvas>
            </div>
          </div>
        </div>
      <% }) %>
    </div>

    <div class="card border-0 shadow">
      <div class="card-header bg-white py-3">
        <h5 class="mb-0 fw-bold"><i class="bi bi-list-task me-2 text-primary"></i>Daftar Soal & Materi</h5>
      </div>
      <div class="card-body p-0">
        <div class="accordion accordion-flush" id="accordionCourses">
          <% if (categories.length > 0) { %>
            <% categories.forEach((cat, indexCat) => { %>
              <% if (cat.Courses && cat.Courses.length > 0) { %>
                <% cat.Courses.forEach((course, indexCourse) => { %>
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= course.id %>">
                        <span class="badge bg-light text-dark border me-2"><%= cat.name %></span>
                        <%= course.name %>
                        <span class="ms-auto badge bg-primary rounded-pill"><%= course.Exercises ? course.Exercises.length : 0 %> Soal</span>
                      </button>
                    </h2>
                    <div id="collapse<%= course.id %>" class="accordion-collapse collapse" data-bs-parent="#accordionCourses">
                      <div class="accordion-body bg-light">
                        <ul class="list-group list-group-flush rounded shadow-sm">
                          <% if (course.Exercises && course.Exercises.length > 0) { %>
                            <% course.Exercises.forEach((ex, i) => { %>
                              <li class="list-group-item d-flex justify-content-between align-items-center p-3">
                                <div>
                                  <span class="fw-bold text-muted me-2">#<%= i + 1 %></span>
                                  <%= ex.question %>
                                  <br>
                                  <small class="text-success"><i class="bi bi-check-circle-fill"></i> Kunci: <%= ex.answerKey %></small>
                                </div>
                                <div class="btn-group">
                                  <a href="/teacher/<%= teacherId %>/exercise/<%= ex.id %>/edit" class="btn btn-outline-warning btn-sm border-0" title="Edit">
                                    <i class="bi bi-pencil-square"></i>
                                  </a>
                                  <form action="/teacher/<%= teacherId %>/exercise/<%= ex.id %>/delete" method="POST" class="d-inline" onsubmit="return confirm('Yakin hapus soal ini?')">
                                    <button type="submit" class="btn btn-outline-danger btn-sm border-0" title="Hapus">
                                      <i class="bi bi-trash"></i>
                                    </button>
                                  </form>
                                </div>
                              </li>
                            <% }) %>
                          <% } else { %>
                            <li class="list-group-item text-center text-muted py-3">Belum ada soal di kursus ini.</li>
                          <% } %>
                        </ul>
                      </div>
                    </div>
                  </div>
                <% }) %>
              <% } %>
            <% }) %>
          <% } else { %>
            <div class="p-4 text-center text-muted">Belum ada kategori tersedia.</div>
          <% } %>
        </div>
      </div>
    </div>
    
    <div class="card border-0 shadow mt-5">
      <div class="card-header bg-white py-3">
        <h5 class="mb-0 fw-bold"><i class="bi bi-trophy me-2 text-warning"></i>Rekap Nilai Siswa</h5>
      </div>
      <div class=\"table-responsive\">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th class="ps-4">Siswa</th>
              <th>Kategori</th>
              <th>Total Skor</th>
            </tr>
          </thead>
          <tbody>
            <% if (scores && scores.length > 0) { %>
              <% scores.forEach(s => { %>
              <tr>
                <td class="ps-4 fw-bold text-dark"><%= s.User.email %></td>
                <td><span class="badge bg-info text-dark bg-opacity-25 border border-info"><%= s.Exercise.Course.Category.name %></span></td>
                <td><span class="fw-bold text-primary fs-5"><%= s.nilaiFinal %></span></td>
              </tr>
              <% }) %>
            <% } else { %>
              <tr><td colspan="3" class="text-center py-3">Belum ada data nilai.</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

 <script id="chart-data-source" type="application/json">
      <%- JSON.stringify(chartDataPerCategory) %>
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Ambil data dari script JSON di atas
        const dataElement = document.getElementById('chart-data-source');
        
        if (dataElement) {
          try {
            const categoriesData = JSON.parse(dataElement.textContent);
            
            // Looping data untuk membuat chart
            categoriesData.forEach((cat, idx) => {
              const canvas = document.getElementById("chart-" + idx);
              if (canvas) {
                new Chart(canvas.getContext("2d"), {
                  type: 'doughnut', // Jenis chart
                  data: {
                    labels: cat.labels,
                    datasets: [{
                      data: cat.scores,
                      backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                      borderWidth: 0
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                      legend: { position: 'bottom', labels: { usePointStyle: true } } 
                    }
                  }
                });
              }
            });
          } catch (error) {
            console.error("Gagal memproses data chart:", error);
          }
        }
      });
    </script>
</body>
</html>